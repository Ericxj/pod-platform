# 权限管理（=菜单管理）审计与交付

## Step 1：审计报告

### 1) 后端审计

**Controller 位置：** `pod-iam/src/main/java/com/pod/iam/controller/PermissionController.java`

**接口清单：**

| 方法 | 路径 | 权限 | 说明 |
|------|------|------|------|
| GET | /api/iam/permissions | iam:perm:page | 分页查询，参数 current/size/keyword/permType |
| GET | /api/iam/permissions/tree | iam:perm:page | 树，参数 permType、includeDisabled |
| GET | /api/iam/permissions/{id} | iam:perm:page | 单条 |
| POST | /api/iam/permissions | iam:perm:create | 新增 |
| PUT | /api/iam/permissions/{id} | iam:perm:update | 更新 |
| DELETE | /api/iam/permissions/{id} | iam:perm:delete | 软删，MENU 有子节点禁止删除 |
| GET | /api/iam/permissions/validate | iam:perm:page | 唯一性校验 |

**参数显式声明（已修复）：**

- **问题：** 未开启 `-parameters` 时，简单类型参数未标注 `@RequestParam(name="")` / `@PathVariable("")` 会导致 `IllegalArgumentException: Name for argument of type [java.lang.String] not specified`。
- **修复：**
  - `page()`：原为 `PermissionPageQuery query`（POJO 绑定），已改为显式 `@RequestParam(value="current")`、`@RequestParam(value="size")`、`@RequestParam(value="keyword")`、`@RequestParam(value="permType")`，在 Controller 内构造 Query。
  - `tree(permType, includeDisabled)`：已使用 `@RequestParam(value="permType", defaultValue="ALL")`、`@RequestParam(value="includeDisabled", defaultValue="false")`。
  - `validate(...)`：已为 permCode、menuPath、apiMethod、apiPath、excludeId、permType 全部使用 `@RequestParam(value="...", required=false)`。
  - `get(id)` / `update(id, dto)` / `delete(id)`：已使用 `@PathVariable("id")`。

**缺失接口：** 无。tree / page / create / update / delete / validate 均已提供。

**其他修复：**

- 父 POM `pod-platform/pom.xml` 已配置 `maven-compiler-plugin` 的 `<parameters>true</parameters>` 作为兜底。
- 分页查询在应用层增加：tenant_id 从 TenantContext 过滤、deleted=0，与 tree 行为一致。

---

### 2) 前端审计

**权限管理页面：** `pod-ui/apps/web-antd/src/views/system/permission/index.vue`

- **占位情况：** 已重写，非占位。包含 Tabs（菜单 / 按钮 / API）、树表（MENU）、分页列表（BUTTON/API）、Drawer 表单。
- **Tree/Table/Drawer/Form：** 已使用 Ant Design Vue 的 `a-tabs`、`a-table`（树形 + 分页）、`useVbenDrawer` + `PermissionDrawer`、表单在 `permission-drawer.vue` 中。
- **API 层：** `src/api/system/permission.ts` 提供 getPermissionTree、pagePermissions、createPermission、updatePermission、deletePermission、validatePermission；`src/api/iam/permissions.ts` 从 system/permission 再导出，页面当前从 `#/api/system/permission` 引用，可改为 `#/api/iam/permissions` 以符合“权限管理 API 归 IAM”的约定。
- **权限按钮：** 已使用 `hasPerm('iam:perm:create')`、`iam:perm:update`、`iam:perm:delete`、`iam:perm:page` 控制按钮显示；开发态若未配置权限码，按钮会被隐藏，需在 iam_permission 中配置并分配给角色后可见。

**结论：** 页面与接口齐全；后端参数显式声明与分页租户/软删过滤已补全；前端仅可选将 import 统一为 `#/api/iam/permissions`。

---

## Step 2：后端实现要点

- **GET /api/iam/permissions/tree**  
  - 参数：`permType`（MENU|BUTTON|API|ALL）、`includeDisabled`（可选）。  
  - tenant_id 从 TenantContext 取，deleted=0，按 parent_id 建树、sort_no 排序；permType=ALL 时返回混合树。

- **GET /api/iam/permissions**  
  - 参数：`current`、`size`、`keyword`、`permType`（均显式 @RequestParam）。  
  - 返回 MyBatis-Plus 分页结构（records、total 等），tenant + deleted=0，keyword 模糊 perm_code/perm_name/menu_path/api_path。

- **POST/PUT/DELETE**  
  - 删除 MENU 时若有子节点则禁止删除并返回明确错误文案；软删为 deleted=1。

- **GET /api/iam/permissions/validate**  
  - permCode 租户内唯一；MENU 的 menuPath 租户内唯一；API 的 apiMethod+apiPath 租户内唯一；excludeId 用于编辑时排除自身。

---

## Step 3：前端实现要点

- **页面：** `src/views/system/permission/index.vue`  
  - Tabs：菜单(MENU) / 按钮(BUTTON) / API(API)。  
  - MENU：树表 + 新增根/新增子级/新增同级/编辑/删除（Drawer）。  
  - BUTTON/API：分页列表 + CRUD，Drawer 中 parent 选 MENU 树；API 必填 api_method、api_path。  
- **API：** `src/api/system/permission.ts` 实现；`src/api/iam/permissions.ts` 统一导出。  
- **联调：** 进入页面即请求 tree(MENU)；增删改后刷新对应树/列表；validate 失败用 message.error 提示。

---

## Step 4：修改文件清单与关键 Diff

### 后端（pod-platform）

| 文件 | 变更摘要 |
|------|----------|
| `pod-iam/.../PermissionController.java` | page() 改为显式 @RequestParam(current, size, keyword, permType)，在 Controller 内构造 PermissionPageQuery |
| `pod-iam/.../IamPermissionApplicationService.java` | page() 增加 tenantId 与 deleted=0 过滤，current/size 空安全默认 1/10 |
| `pom.xml`（父 POM） | maven-compiler-plugin 已含 `<parameters>true</parameters>`（此前已加） |

### 前端（pod-ui/apps/web-antd）

| 文件 | 变更摘要 |
|------|----------|
| `src/views/system/permission/index.vue` | 已为生产级实现（Tabs + 树表 + 分页列表 + Drawer），无需再改 |
| `src/views/system/permission/permission-drawer.vue` | 按 drawerType 动态表单项，保存前 validatePermission，create/update 调用 API |
| `src/api/system/permission.ts` | getPermissionTree、pagePermissions、create/update/delete/validatePermission，分页传 current/size |
| `src/api/iam/permissions.ts` | 从 system/permission 再导出，供“权限管理=IAM”语义使用 |

### 关键 Diff（摘要）

- **PermissionController.page()**  
  - 原：`Result<IPage<IamPermission>> page(PermissionPageQuery query)`  
  - 现：`page(@RequestParam(value="current", required=false) Long current, @RequestParam(value="size", required=false) Long size, @RequestParam(value="keyword", required=false) String keyword, @RequestParam(value="permType", required=false) String permType)`，方法内 new PermissionPageQuery 并 set 后调用 service。

- **IamPermissionApplicationService.page()**  
  - 增加：`Long tenantId = TenantContext.getTenantId();`，若非空则 `wrapper.eq(IamPermission::getTenantId, tenantId);`，以及 `wrapper.eq(IamPermission::getDeleted, 0);`；current/size 空时默认 1L/10L。

---

## 验收步骤

1. **进入权限管理 → 菜单树显示 System 及子菜单**  
   - 登录后进入「权限管理」页，默认「菜单」Tab。  
   - 应看到 GET `/api/iam/permissions/tree?permType=MENU` 成功，树表展示 System 及其子菜单（含路径、组件、排序、状态等）。  

2. **新增菜单 → 保存后树刷新出现**  
   - 点击「新增根菜单」或某行的「新增子级/同级」，在 Drawer 中填写权限码、名称、路径等，保存。  
   - 应 POST `/api/iam/permissions` 成功，Drawer 关闭后当前 Tab 树自动刷新，新节点出现在树中。  

3. **新增 API 权限 → 列表出现；validate 防重复**  
   - 切换到「API」Tab，点击「新增接口权限」，填写权限码、api_method、api_path 等，保存。  
   - 列表应刷新并出现新记录。  
   - 再新增一条相同 api_method+api_path（同租户），保存前应调用 validate，返回冲突并 message 提示，不提交。  

4. **删除有子节点菜单 → 提示禁止删除**  
   - 在「菜单」Tab 选中一个有子节点的菜单，点击「删除」并确认。  
   - 应调用 DELETE `/api/iam/permissions/{id}`，后端返回 4xx 及明确错误信息（如 “Cannot delete menu with children, remove or move children first”），前端 message.error 展示，该菜单未被删除。  

---

**交付状态：** 审计完成，后端显式参数与分页租户/软删已实现，前端权限管理页与 API 已实现并可联调；按上述 4 步验收通过即可视为达标。
