# 系统管理（System）现状扫描结果

## 1. 登录上下文

- **类**: `com.pod.common.core.context.TenantContext`
- **用法**: `TenantContext.getTenantId()`, `TenantContext.getFactoryId()`, `TenantContext.getUserId()`
- **注入时机**: `com.pod.iam.filter.JwtAuthenticationFilter` 从 JWT 解析后调用 `TenantContext.setTenantId/setFactoryId/setUserId`

## 2. 权限注解

- **注解**: `com.pod.common.core.annotation.RequirePerm`
- **用法**: `@RequirePerm("iam:user:list")` 等，权限码与后端校验一致
- **切面**: `com.pod.iam.aspect.PermissionAspect` 的 `checkPermission`，依赖 `TenantContext.getUserId()` 与当前用户权限校验

## 3. 已有接口

| 路径 | 方法 | 说明 |
|------|------|------|
| `/api/iam/me` | GET | MeController，返回当前用户 IamUser |
| `/api/iam/me/menus` | GET | MeController，返回 `{ menus, permissionCodes, dataScopes }` |
| `/api/iam/me/perms` | GET | MeController，返回 `{ permissionCodes }` |
| `/api/iam/me/switchFactory` | POST | FactoryController（RequestMapping `/api/iam`），body `{ factoryId }`，校验 data_scope 后返回新 token |
| `/api/iam/users` | GET/POST/PUT/DELETE | IamUserController，分页/创建/更新/软删 |
| `/api/iam/users/{id}` | GET | 用户详情（含 roleIds） |
| `/api/iam/users/{id}/factoryScopes` | GET/PUT | 用户工厂范围 |
| `/api/iam/users/{id}/password` | PUT | 重置密码 |
| `/api/iam/roles` | GET/POST | RoleController，分页/创建 |
| `/api/iam/roles/{id}` | GET/PUT/DELETE | 详情/更新/软删 |
| `/api/iam/roles/{id}/permissions` | GET | 返回 `{ permIds }` |
| `/api/iam/roles/{id}/grantPermissions` | POST | 授权，body GrantPermissionsDto `{ permIds }` |
| `/api/iam/permissions/tree` | GET | PermissionController，permType=MENU|BUTTON|API|ALL |
| `/api/iam/permissions/{id}` | GET/POST/PUT/DELETE | 详情/创建/更新/软删 |
| `/api/iam/permissions/validate` | GET | 校验 permCode/menuPath/apiMethod/apiPath |
| `/api/iam/factories/my` | GET | 当前用户可访问工厂 ID 列表 |

## 4. 用户接口对齐

- 用户 list 权限码为 `iam:user:list`（与需求 iam:user:page 不一致，需求要求 permissionCodes 与 @RequirePerm 一致，当前为 list，保持不变则前端用 iam:user:list；若统一为 page 需改 Controller + 库表 perm_code）。

## 5. 表结构（pod_os_ddl.sql）

- **iam_tenant**: 已存在，含 tenant_code, tenant_name, status 等，通用字段齐全
- **iam_factory**: 已存在，含 tenant_id, factory_code, factory_name, status 等，通用字段齐全
- **iam_permission**: 已存在
- **iam_data_scope**: 已存在，subject_type, subject_id, scope_type, scope_id, status
- **iam_role**, **iam_role_permission**: 已存在

## 6. 后端待补齐/修正

- Role: 增加 `PUT /api/iam/roles/{id}/permissions` body `{ permIds }`（与现有 POST grantPermissions 行为一致，接口契约统一为 PUT）
- Permission: 增加 `GET /api/iam/permissions?page&size&keyword&permType` 分页列表
- DataScope: 新增 DataScopeController，`GET/PUT /api/iam/dataScopes?subjectType&subjectId&scopeType`；用户工厂范围已有，保留
- Tenant/Factory: 无 IamTenant/IamFactory 实体与 Mapper，需新增 domain/mapper/application/controller 及 CRUD
- Menus 契约: MenuQueryService 已 trim、去前导 `/`、LAYOUT 统一；需确认 meta 含 title、order、keepAlive、hideInMenu（已含）
