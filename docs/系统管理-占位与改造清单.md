# 系统管理 - 占位实现与改造清单

本文档基于 pod-platform 仓库检索结果，汇总「系统管理」相关前端路由、后端接口、iam_* 表结构及 mock/可用标注，并给出按优先级的改造建议。

---

## 1) 系统管理菜单与页面的实际路由文件位置

### 1.1 Playground（静态路由）

| 路由路径 | 路由定义文件 | 页面组件 |
|---------|--------------|----------|
| `/system`（父） | `pod-ui/playground/src/router/routes/modules/system.ts` | 无（仅作为目录） |
| `/system/role` | 同上 | `pod-ui/playground/src/views/system/role/list.vue` |
| `/system/menu` | 同上 | `pod-ui/playground/src/views/system/menu/list.vue` |
| `/system/dept` | 同上 | `pod-ui/playground/src/views/system/dept/list.vue` |

- **路由模块入口**：`pod-ui/playground/src/router/routes/modules/system.ts`
- **菜单文案**：来自 `pod-ui/playground/src/locales/langs/zh-CN/system.json`（`system.title` = 「系统管理」等）
- **API 封装**：`pod-ui/playground/src/api/system/role.ts`、`menu.ts`、`dept.ts`，请求路径为 `/system/role/*`、`/system/menu/*`、`/system/dept/*`（由 mock 或网关转发）

### 1.2 web-antd（动态路由，菜单来自后端）

菜单与路由由 **`/api/iam/me/menus`** 返回的菜单树动态生成，不再有单独的「系统管理」静态路由文件。

- **路由/菜单生成逻辑**：`pod-ui/apps/web-antd/src/router/access.ts`（`generateAccess` → `getUserMenusApi()` → `generateAccessible`）
- **系统管理相关页面组件**（根据菜单 path 解析到以下视图）：

| 菜单/路由（示例） | 页面组件位置 | 说明 |
|------------------|--------------|------|
| `/system/user` | `pod-ui/apps/web-antd/src/views/system/user/index.vue` | 用户管理，完整 CRUD |
| `/system/role` | `pod-ui/apps/web-antd/src/views/system/role/index.vue` | 占位页：「角色管理功能开发中...」 |
| `/system/menu` | `pod-ui/apps/web-antd/src/views/system/menu/index.vue` | 占位页：「菜单管理功能开发中...」 |
| `/system/diagnose`（或后端配置的 path） | `pod-ui/apps/web-antd/src/views/system/diagnose/index.vue` | AI 智能诊断（系统权限健康诊断） |

- **用户相关 API**：`pod-ui/apps/web-antd/src/api/system/user.ts`（请求 `/iam/users`，即对接真实 pod-iam）
- **诊断 API**：`pod-ui/apps/web-antd/src/api/ai.ts`（请求 `/iam/ai/diagnose`、`/iam/ai/diagnose/{id}`）

---

## 2) 后端已存在的接口列表（pod-iam）

以下为 **pod-iam** 模块中已存在的接口：路径、方法、入参、是否鉴权。

| 路径 | 方法 | 入参/说明 | 鉴权 |
|------|------|-----------|------|
| `/api/iam/auth/login` | POST | Body: `LoginDto`（如 username, password） | 否（`permitAll`） |
| `/api/iam/auth/logout` | POST | 无 | 否（permitAll，客户端丢弃 token 即可） |
| `/api/iam/me` | GET | 无 | 是（需登录，取当前用户） |
| `/api/iam/me/menus` | GET | 无 | 是（返回菜单树 + permissionCodes + dataScopes） |
| `/api/iam/me/perms` | GET | 无 | 是 |
| `/api/iam/users` | GET | Query: 分页/筛选（如 `UserPageQuery`） | 是，`RequirePerm("iam:user:list")` |
| `/api/iam/users/{id}` | GET | Path: id | 是，`RequirePerm("iam:user:query")` |
| `/api/iam/users` | POST | Body: `UserDto` | 是，`RequirePerm("iam:user:create")` |
| `/api/iam/users` | PUT | Body: `UserDto` | 是，`RequirePerm("iam:user:update")` |
| `/api/iam/users/{id}` | DELETE | Path: id | 是，`RequirePerm("iam:user:delete")` |
| `/api/iam/users/{id}/password` | PUT | Path: id；Body: `{ "password": "..." }` | 是，`RequirePerm("iam:user:reset_pwd")` |
| `/api/iam/factories/my` | GET | 无 | 是（需登录） |
| `/api/iam/me/switchFactory` | POST | Body: `{ "factoryId": Long }` | 是 |
| `/api/iam/menus/validate` | GET | Query: `factoryId`（可选） | 是（需租户/工厂上下文） |
| `/api/iam/ai/diagnose` | POST | Body: `{ "type", "businessKey" }` | 是，`PreAuthorize("hasAuthority('SysAiDiagnosis')")` |
| `/api/iam/ai/diagnose/{id}` | GET | Path: id | 是，`PreAuthorize("hasAuthority('SysAiDiagnosis')")` |

- **鉴权说明**：除 `SecurityConfig` 中 `requestMatchers("/api/iam/auth/**").permitAll()` 外，其余均为 `authenticated()`；用户相关接口另加 `@RequirePerm` 权限码。
- **角色、菜单（权限树）、部门**：当前 **没有** 对应的 CRUD 控制器（无 `/api/iam/roles`、`/api/iam/menus` 树形增删改、`/api/iam/depts`）。

---

## 3) iam_* 相关表清单与字段差异（通用字段）

库表定义见：`pod-platform/db/pod_os_ddl.sql`；唯一索引调整见：`pod-platform/db/migration/V2__unique_index_add_tenant_factory_deleted.sql`。

### 3.1 表清单与通用字段

| 表名 | tenant_id | factory_id | deleted | version | 说明 |
|------|-----------|------------|---------|---------|------|
| `iam_data_scope` | ✓ | ✓ | ✓ | ✓ | 数据权限范围（主体类型/范围类型/范围 ID） |
| `iam_factory` | ✓ | ✓ | ✓ | ✓ | 工厂/履约主体 |
| `iam_permission` | ✓ | ✓ | ✓ | ✓ | 权限点（菜单/按钮/API），树形 parent_id |
| `iam_role` | ✓ | ✓ | ✓ | ✓ | 角色 |
| `iam_role_permission` | ✓ | ✓ | ✓ | ✓ | 角色-权限关联 |
| `iam_tenant` | ✓ | ✓ | ✓ | ✓ | 租户（首条为 id=1, tenant_id=0, factory_id=0） |
| `iam_user` | ✓ | ✓ | ✓ | ✓ | 用户 |
| `iam_user_role` | ✓ | ✓ | ✓ | ✓ | 用户-角色关联 |

以上 8 张表均包含：`tenant_id`、`factory_id`、`deleted`、`version`，以及常见审计字段（如 `created_at`、`updated_at`、`created_by`、`updated_by`、`trace_id`）。

### 3.2 唯一约束（V2 迁移后）

- **iam_factory**：`uk_tenant_factory_code(tenant_id, factory_id, factory_code, deleted)`
- **iam_permission**：`uk_perm_code(tenant_id, factory_id, perm_code, deleted)`
- **iam_role**：`uk_role_code(tenant_id, factory_id, role_code, deleted)`
- **iam_role_permission**：`uk_role_perm(tenant_id, factory_id, role_id, perm_id, deleted)`
- **iam_tenant**：`uk_tenant_code(tenant_id, factory_id, tenant_code, deleted)`
- **iam_user**：`uk_user_username(tenant_id, factory_id, username, deleted)`
- **iam_user_role**：`uk_user_role(tenant_id, factory_id, user_id, role_id, deleted)`

### 3.3 说明

- **部门**：无 `iam_dept` 表，当前「部门」仅存在于前端/backend-mock 的占位中。
- **iam_tenant**：注释中状态为 `ACTIVE/LOCKED`，初始数据使用 `ENABLED`，若需统一可后续用枚举约束或数据修复。

---

## 4) 标注：mock/占位 vs 已可用

### 4.1 已可用（对接真实 pod-iam 或 DB）

| 能力 | 前端 | 后端 | 说明 |
|------|------|------|------|
| 登录/登出 | web-antd 等 | `AuthController` | 使用 JWT，无服务端会话 |
| 当前用户与菜单/权限 | web-antd | `MeController`（me、menus、perms） | 菜单来自 `iam_permission`，按租户/工厂/用户过滤 |
| 用户管理 CRUD + 重置密码 | web-antd `system/user` | `IamUserController` | 请求 `/iam/users`，权限码控制 |
| 工厂切换 | - | `FactoryController`（factories/my、me/switchFactory） | 依赖数据权限与 token 中的 factoryId |
| 菜单校验 | - | `MenuValidationController`（menus/validate） | 用于启动/运维校验菜单数据 |
| AI 诊断 | web-antd `system/diagnose` | `AiDiagnosisController` | 需权限 `SysAiDiagnosis` |

### 4.2 Mock / 占位

| 能力 | 前端 | 后端/数据 | 说明 |
|------|------|-----------|------|
| 角色 CRUD | Playground：`system/role` 完整列表/表单；web-antd：仅占位页「角色管理功能开发中...」 | 无 RoleController；有 `iam_role`、`iam_role_permission` 表 | 数据可查可写，但无 REST API；Playground 调 `/system/role/*` → backend-mock |
| 菜单（权限树）CRUD | Playground：`system/menu` 完整列表/表单；web-antd：仅占位页「菜单管理功能开发中...」 | 无 Permission/Menu CRUD 控制器；有 `iam_permission` 表，菜单由 `/me/menus` 只读使用 | Playground 调 `/system/menu/*` → backend-mock |
| 部门 CRUD | Playground：`system/dept` 完整列表/表单 | 无 DeptController，**无 iam_dept 表** | 纯 mock，backend-mock 提供 `/api/system/dept/*`；演示环境对 `/api/system/*` 写操作 403 |

- **backend-mock**：  
  - `pod-ui/apps/backend-mock/api/system/` 下：role（list 等）、menu（list、name-exists、path-exists）、dept（list、post、put、delete）。  
  - `pod-ui/apps/backend-mock/middleware/1.api.ts`：对以 `/api/system/` 开头的写请求返回 403「演示环境，禁止修改」。

---

## 5) 下一步改造建议（按优先级）

### P0：后端补齐角色、权限（菜单）读写 API

- **目标**：让「角色管理」「菜单管理」有真实接口可对接，不再依赖 mock。
- **建议**：
  - 在 pod-iam 中新增 **RoleController**（如 `/api/iam/roles`）：分页列表、详情、创建、更新、删除；入参/出参与 `iam_role`、`iam_role_permission` 对齐，并带 `tenant_id`/`factory_id`（可从上下文取）。
  - 新增 **PermissionController**（如 `/api/iam/permissions` 或 `/api/iam/menus`）：树形列表（基于 `iam_permission` 的 parent_id）、单条增删改、名称/路径唯一性校验（可复用或对齐 MenuValidationController 的校验逻辑）。
- **权限码**：与现有 `iam:user:*` 风格一致，例如 `iam:role:list`、`iam:role:create` 等，并在 `iam_permission` 中维护。

### P1：web-antd 角色/菜单页面对接真实 API

- **目标**：替换占位页为真实角色管理、菜单（权限）管理。
- **建议**：
  - 在 web-antd 中新增或复用 `api/system/role.ts`、`api/system/menu.ts`（或 `api/iam/role.ts`、`api/iam/menu.ts`），请求上述新接口（如 `/api/iam/roles`、`/api/iam/permissions`）。
  - 将 `views/system/role/index.vue`、`views/system/menu/index.vue` 改为与 Playground 类似的列表+表单（或复用组件），数据源改为真实 API。

### P2：Playground 与 mock 策略统一

- **目标**：避免长期两套接口（/system/* mock 与 /api/iam/* 真实）并存导致混淆。
- **建议**：
  - 若以 web-antd + pod-iam 为主：将 Playground 的 system/role、system/menu 改为调用 `/api/iam/roles`、`/api/iam/permissions`（与 web-antd 一致），或仅保留演示用静态数据，不再依赖 backend-mock 的 `/api/system/*`。
  - 部门：若业务需要「部门」，先定是否建 `iam_dept` 表并在 pod-iam 提供接口；若不需要，则从菜单和 Playground 中移除或保留为占位说明。

### P3：数据与枚举统一

- **目标**：表结构、初始数据与注释一致。
- **建议**：
  - 统一 `iam_tenant.status` 与 `iam_factory.status` 等枚举（如 ENABLED/DISABLED 或 ACTIVE/INACTIVE），并在 DDL 或 seed 中统一；必要时增加 CHECK 或应用层校验。
  - 确认 `iam_tenant` 中 `tenant_id`/`factory_id` 的语义（当前首条为 0,0），避免与多租户扩展冲突。

### P4：权限码与菜单配置

- **目标**：新接口的权限码在菜单/按钮上可配置、可分配。
- **建议**：
  - 在 `iam_permission` 中新增角色、权限（菜单）管理相关权限点（如 `iam:role:list`、`iam:permission:list` 等），并挂到系统管理菜单下；为管理员角色分配这些权限，便于后续做细粒度控制。

---

**文档生成时间**：基于当前代码与 DB 结构检索结果。实施时请以实际分支与迁移状态为准。
