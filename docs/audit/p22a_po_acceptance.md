# P2.2-A 采购单主流程验收说明

## 1. 创建供应商

1. 登录系统，进入 **SRM → 供应商管理**。
2. 点击「新增」，填写：
   - 供应商编码：如 `SUP001`（唯一）
   - 供应商名称：如 `测试供应商`
   - 联系人、电话、邮箱、地址、备注（可选）
   - 状态：启用
3. 保存后列表中应出现该供应商，状态为「启用」。
4. 可执行「禁用」，再「启用」，验证 enable/disable 正常。

## 2. 创建采购单

1. 进入 **SRM → 采购单管理**。
2. 点击「新建采购单」：
   - 选择刚创建的供应商；
   - 币种：CNY（可改）；
   - 预计到货日期：可选。
3. 保存后列表出现新采购单，状态为 **DRAFT**，采购单号唯一（如 PO20260214xxxx）。

## 3. 添加 2 行 SKU

1. 在列表中点击该采购单的「查看」，打开详情弹窗。
2. 在草稿状态下点击「添加行」：
   - 搜索并选择第一个 SKU（需 PRD 中已有 SKU），输入数量、单价；
   - 保存。
3. 再次「添加行」，选择第二个 SKU，输入数量、单价，保存。
4. 详情中应显示 2 行，且表头总数量、总金额已汇总。

## 4. 提交 → 审批

1. 在详情中点击「提交」：
   - 状态应由 **DRAFT** 变为 **SUBMITTED**。
2. 点击「审批」：
   - 状态应由 **SUBMITTED** 变为 **APPROVED**。

## 5. 状态流转正确性

| 当前状态   | 允许操作   | 下一状态   |
|-----------|------------|------------|
| DRAFT     | 提交、取消 | SUBMITTED / CANCELED |
| SUBMITTED | 审批、取消 | APPROVED / CANCELED   |
| APPROVED  | 关闭       | CLOSED     |
| CLOSED    | -          | -          |
| CANCELED  | -          | -          |

- 仅 **DRAFT** 可添加/编辑行、提交。
- 仅 **SUBMITTED** 可审批。
- 仅 **APPROVED** 可关闭。

## 6. 非法流转报错

- 对 **APPROVED** 的采购单再点「提交」或「审批」：应返回 4xx 或业务错误，提示状态不允许。
- 对 **DRAFT** 无行或数量为 0 时点「提交」：应提示必须有行且 qty>0。
- 对 **CLOSED** / **CANCELED** 再执行提交/审批/取消/关闭：应报错。

## 7. 幂等与乐观锁

- **版本冲突**：两人同时打开同一采购单，A 先提交成功，B 再提交时应得到 **409** 或明确提示「版本冲突，请刷新后重试」；不应静默覆盖。
- 后端使用 `WHERE status=? AND version=?` 更新，更新行数为 0 时返回 409。

## 验收检查表

- [ ] 供应商 CRUD、启用/禁用正常
- [ ] 采购单创建为草稿，单号唯一
- [ ] 可添加多行 SKU（至少 2 行），总数量/总金额正确
- [ ] 提交：DRAFT → SUBMITTED
- [ ] 审批：SUBMITTED → APPROVED
- [ ] 取消：DRAFT/SUBMITTED → CANCELED
- [ ] 关闭：APPROVED → CLOSED
- [ ] 非法状态操作返回错误
- [ ] 乐观锁冲突时返回 409 或明确错误信息
