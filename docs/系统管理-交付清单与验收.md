# 系统管理（System）生产级模块 - 交付清单与验收

## 一、修改/新增文件清单

### 后端（pod-iam）

| 文件 | 操作 |
|------|------|
| `controller/RoleController.java` | 修改：新增 PUT /api/iam/roles/{id}/permissions |
| `controller/PermissionController.java` | 修改：新增 GET /api/iam/permissions 分页 |
| `controller/DataScopeController.java` | 新增 |
| `controller/TenantController.java` | 新增 |
| `controller/FactoryCrudController.java` | 新增（/api/iam/factories CRUD + /my） |
| `controller/FactoryController.java` | 修改：移除 /factories/my，保留 /me/switchFactory |
| `controller/IamUserController.java` | 修改：新增 GET/PUT /api/iam/users/{id}/roles |
| `application/DataScopeService.java` | 修改：新增 getScopeIds/setScopeIds 通用方法 |
| `application/IamPermissionApplicationService.java` | 修改：新增 page(PermissionPageQuery) |
| `application/IamUserApplicationService.java` | 已有 setUserRoles（供 PUT roles 使用） |
| `application/IamRoleApplicationService.java` | 修改：page 支持 keyword |
| `application/IamTenantApplicationService.java` | 新增 |
| `application/IamFactoryApplicationService.java` | 新增 |
| `dto/PermissionPageQuery.java` | 新增 |
| `dto/DataScopeUpdateDto.java` | 新增 |
| `dto/DataScopeQueryDto.java` | 新增 |
| `dto/TenantPageQuery.java` | 新增 |
| `dto/FactoryPageQuery.java` | 新增 |
| `dto/RolePageQuery.java` | 修改：新增 keyword |
| `domain/IamTenant.java` | 新增 |
| `domain/IamFactory.java` | 新增 |
| `mapper/IamTenantMapper.java` | 新增 |
| `mapper/IamFactoryMapper.java` | 新增 |

### 前端（pod-ui/apps/web-antd）

| 文件 | 操作 |
|------|------|
| `src/api/system/role.ts` | 修改：keyword、putRolePermissions |
| `src/api/system/user.ts` | 修改：getUserRoles、putUserRoles |
| `src/api/system/permission.ts` | 修改：getPermissionPage、PermissionPageQuery |
| `src/api/system/scopes.ts` | 新增 |
| `src/api/system/tenants.ts` | 新增 |
| `src/api/system/factories.ts` | 新增 |
| `src/views/system/data-scope/index.vue` | 新增（Ant Design Vue） |
| `src/views/system/tenant/index.vue` | 新增（Ant Design Vue） |
| `src/views/system/factory/index.vue` | 新增（Ant Design Vue） |

说明：`system/user`、`system/role`、`system/permission` 已使用 `#/components/Page`（此前修复），未引用 vxe-table 的 Page；仍使用 useVbenVxeGrid 做表格，若需“完全不引用 vxe-table adapter”可再改为纯 a-table。

### 数据库与文档

| 文件 | 操作 |
|------|------|
| `db/pod_iam_system_menus_init.sql` | 新增：System 菜单 data-scope/tenant/factory + 权限点 + 授权 ADMIN |
| `docs/系统管理-现状扫描结果.md` | 新增 |
| `docs/系统管理-交付清单与验收.md` | 本文件 |

---

## 二、关键 Diff 摘要

- **RoleController**：`PUT /api/iam/roles/{id}/permissions`，body `RolePermissionsDto { permIds }`，内部调用现有 `grantPermissions`。
- **PermissionController**：`GET /api/iam/permissions?current&size&keyword&permType`，返回分页列表。
- **DataScopeController**：`GET /api/iam/dataScopes?subjectType&subjectId&scopeType` → `{ scopeIds }`；`PUT /api/iam/dataScopes` body `DataScopeUpdateDto`，全量覆盖。
- **TenantController / FactoryCrudController**：标准 CRUD；Factory 提供 `GET /api/iam/factories/all?tenantId` 供多选。
- **DataScopeService**：`getScopeIds(subjectType, subjectId, scopeType)`、`setScopeIds(..., scopeIds)`，set 时先软删旧记录再插入。
- **IamUserController**：`GET /api/iam/users/{id}/roles`、`PUT /api/iam/users/{id}/roles` body `{ roleIds }`。
- **MenuQueryService**：已具备 component trim、去前导 `/`、LAYOUT 统一、meta 含 title/order/keepAlive/hideInMenu，无需再改。

---

## 三、数据初始化

1. 执行 `db/pod_iam_system_menus_init.sql`（在已存在 iam_permission、iam_role_permission 的环境执行）。
2. 若 id 冲突，请先调整 SQL 中的 id 或删除已存在的同 id 记录后再执行。

---

## 四、最少 10 条验收步骤

1. **登录与首页**：登录成功后立即跳转到首个叶子菜单（如 /system/user），不停留在登录页。
2. **用户 CRUD**：进入「用户管理」，分页、搜索、新增、编辑、删除、重置密码均正常；无权限时按钮不显示或接口返回 403。
3. **用户分配角色**：用户详情/编辑中可多选角色，保存后调用 PUT /api/iam/users/{id}/roles，再次打开角色正确回显。
4. **用户工厂范围**：用户详情中可多选工厂，保存 PUT /api/iam/users/{id}/factoryScopes；切换工厂时仅能选到已分配工厂。
5. **角色 CRUD**：角色管理分页、关键词、状态筛选、新增、编辑（禁止改 roleCode）、软删正常。
6. **角色授权**：角色详情中树形勾选权限，保存调用 PUT /api/iam/roles/{id}/permissions，再次打开勾选正确。
7. **权限/菜单 CRUD**：权限管理树与分页列表、新增/编辑/删除、validate 接口校验唯一性正常。
8. **数据权限**：进入「数据权限管理」，选择主体类型+主体 ID+范围类型，加载并编辑工厂范围，保存后 GET 与 PUT /api/iam/dataScopes 一致。
9. **切换工厂**：调用 POST /api/iam/me/switchFactory body `{ factoryId }`，仅当该 factoryId 在 iam_data_scope 中已授权时成功并返回新 token；未授权返回 403。
10. **租户/工厂 CRUD**：租户管理、工厂管理分页、搜索、新增、编辑、软删正常；工厂支持按 tenantId 筛选，/api/iam/factories/all 可供前端多选。
11. **无权限按钮隐藏**：使用无权限账号登录，仅分配部分菜单/权限，对应无权限的按钮不显示或点击后接口 403。
12. **后端 403 校验**：直接调用无权限接口（如无 iam:tenant:create 时 POST /api/iam/tenants），返回 403，与 /api/iam/me/perms 中的 permissionCodes 一致。

---

## 五、接口与权限码对齐

- 权限码与后端 `@RequirePerm` 一致，如：iam:user:list、iam:user:create、iam:user:update、iam:user:delete、iam:user:query、iam:user:reset_pwd；iam:role:page、iam:role:create、iam:role:update、iam:role:delete、iam:role:grant；iam:perm:page、iam:perm:create、iam:perm:update、iam:perm:delete；iam:scope:query、iam:scope:update；iam:tenant:page/create/update/delete；iam:factory:page/create/update/delete。
- 前端 `hasPerm('iam:xxx:yyy')` 与上述一致即可控制按钮显示。
